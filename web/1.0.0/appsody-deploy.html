<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Appsody - Deploy to remote cluster :: Learning CP4Apps Accelerators for Teams 101</title>
    <link rel="canonical" href="https://cp4apps.cloudnative101.dev/web/1.0.0/appsody-deploy.html">
    <meta name="generator" content="Antora 2.0.1">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-149377589-1"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','UA-149377589-1')</script>
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <p>Cloud Pak for Applications (CP4Apps) - ”Accelerators for Teams” - Cloud Native 101</p>
      </div>
    </div>
    <div id="topbar-nav" class="navbar-menu">
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="web" data-version="1.0.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="kabanero-overview.html">Learning CP4Apps Accelerators for Teams</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="kabanero-overview.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Installing Cloud Pack for Applications</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-text"><a href="https://cloud.ibm.com/catalog/content/ibm-cp-applications" target="_blank" rel="noopener">Using IBM Cloud Console ↗</a></span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text"><a href="https://www.ibm.com/support/knowledgecenter/en/SSCSJL_4.1.x/install-icpa-cli.html" target="_blank" rel="noopener">OCP4 CLI Installer ↗</a></span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text"><a href="https://www.ibm.com/support/knowledgecenter/en/SSCSJL/install-icpa-cli.html" target="_blank" rel="noopener">OCP3 CLI Installer ↗</a></span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Workflows</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="e2e-java-spring-boot2.html">E2E Java Spring Boot 2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="e2e-java-openliberty.html">E2E Java OpenLiberty</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="e2e-nodejs-express.html">E2E Node.js Express</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Tasks</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="appsody-deploy.html">Appsody Deploy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="codewind-setup-appsody.html">Configure CodeWind</a>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text"><a href="https://www.ibm.com/support/knowledgecenter/SSCSJL_4.1.x/guides/guide-working-with-stacks/README.html" target="_blank" rel="noopener">Customizing Application Stacks ↗</a></span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text"><a href="https://www.ibm.com/support/knowledgecenter/SSCSJL_4.1.x/guides/guide-curating-pipelines/curating.html" target="_blank" rel="noopener">Creating and updating tasks and pipelines ↗</a></span>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tekton-credentials-github.html">Configure Github Credentials</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tekton-credentials-docker.html">Configure Docker Credentials</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">External Resources</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-text"><a href="https://developer.ibm.com/technologies/containers/tutorials/create-appsody-stack" target="_blank" rel="noopener">Create Appsody Stack ↗</a></span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text"><a href="https://github.com/gcharters/kabanero-dev-getting-started" target="_blank" rel="noopener">Java MicroProfile Tutorial ↗</a></span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text"><a href="https://developer.ibm.com/components/cloud-pak-for-applications" target="_blank" rel="noopener">IBM Cloud Pak for Applications @ IBM Developer ↗</a></span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="references.html">References</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Learning CP4Apps Accelerators for Teams</span>
    <span class="version">1.0.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Learning CP4Apps Accelerators for Teams</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="kabanero-overview.html">1.0.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="kabanero-overview.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="kabanero-overview.html">Learning CP4Apps Accelerators for Teams</a></li>
    <li>Tasks</li>
    <li><a href="appsody-deploy.html">Appsody Deploy</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/ibm-cloud-architecture/learning-cp4apps-101/edit/master/modules/ROOT/pages/appsody-deploy.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Appsody - Deploy to remote cluster</h1>
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Recently updated to include RedHat OpenShift 4.x
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configure_image_registry"><a class="anchor" href="#_configure_image_registry"></a>Configure Image Registry</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We are going to use a managed OpenShift cluter on IBM Cloud</p>
</div>
<div class="paragraph">
<p>Follow the documentation <a href="https://cloud.ibm.com/docs/openshift?topic=openshift-openshift-images" class="bare">https://cloud.ibm.com/docs/openshift?topic=openshift-openshift-images</a> to expose the internal image registry, this will allow you to push images from your local workstation to the remote registry.</p>
</div>
<div class="paragraph">
<p>Here is the TLDR; for this section</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Setup docker login for CRC (Code Ready Containers)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>export INTERNAL_IMAGE_REGISTRY=image-registry.openshift-image-registry.svc:5000
export IMAGE_REGISTRY=$(oc get route default-route  -n openshift-image-registry -o jsonpath="{.spec.host}")
docker login -u kubeadmin -p $(oc whoami -t) $IMAGE_REGISTRY</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a route for OCP 4.x</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>oc create route reencrypt image-registry --service=image-registry -n openshift-image-registry
oc patch route image-registry -n openshift-image-registry --type='json' -p='[{"op": "add", "path": "/metadata/annotations/haproxy.router.openshift.io~1balance", "value":"source"}]'
export INTERNAL_IMAGE_REGISTRY=image-registry.openshift-image-registry.svc:5000
export IMAGE_REGISTRY=$(oc get route image-registry -n openshift-image-registry -o jsonpath="{.spec.host}")</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker login -u $(oc whoami) -p $(oc whoami -t) $IMAGE_REGISTRY</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Docker login not working with oc whoami
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>If you are using the <code>kubeadmin</code> account on OCP 4.x, the command <code>oc whoami</code> returns <code>kube:admin</code> and this value will not let you login using docker cli, to workaround use the username <code>kubeadmin</code> explicit in the command</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker login -u kubeadmin -p $(oc whoami -t) $IMAGE_REGISTRY</code></pre>
</div>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a route for OCP 3.11</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>oc create route reencrypt docker-registry --service=docker-registry -n default
oc patch route docker-registry -n default --type='json' -p='[{"op": "add", "path": "/metadata/annotations/haproxy.router.openshift.io~1balance", "value":"source"}]'
export INTERNAL_IMAGE_REGISTRY=docker-registry.default.svc:5000
export IMAGE_REGISTRY=$(oc get route docker-registry -n default -o jsonpath="{.spec.host}")
docker login -u $(oc whoami) -p $(oc whoami -t) $IMAGE_REGISTRY</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Working with insecured image registries
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>If using the IBM Cloud OpenShift you should not have problems with docker login, but if you are using another opnshift cluster and get an error about https/ssl., then add the registry to the Docker Engine config (ie Docker&#8594;Preferences&#8594;Docker Engine) for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "insecure-registries": [
    "default-route-openshift-image-registry.apps-crc.testing",
    "image-registry-openshift-image-registry.apps.foobar.os.fyre.ibm.com",
    "1.2.3.4.nip.io:5000"
  ]
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_application"><a class="anchor" href="#_create_application"></a>Create Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create a new appsody application, or use existing one.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mkdir appsody-app
cd appsody-app
appsody init kabanero/nodejs-express</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup_application_manifest"><a class="anchor" href="#_setup_application_manifest"></a>Setup Application manifest</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create a namespace to deploy the application for personal dev, for example <code>my-project</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc new-project my-project
export NAMESPACE=$(oc project -q)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Generate an appsody deploy yaml and rename it to <code>app-deploy-remote.yaml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">appsody deploy --generate-only -n $NAMESPACE</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_the_application"><a class="anchor" href="#_deploy_the_application"></a>Deploy the Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Build and push the application image to the remote registry</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export APP_NAME=$(yq r app-deploy.yaml metadata.name)
export IMAGE_NAME=${APP_NAME}
export IMAGE_TAG=${RANDOM}
appsody deploy \
  --tag "${NAMESPACE}/${IMAGE_NAME}:${IMAGE_TAG}" \
  --push-url "${IMAGE_REGISTRY}" \
  --pull-url "${INTERNAL_IMAGE_REGISTRY}"
  -n ${NAMESPACE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to use Serverless then append <code>--knative</code> to the appsody deploy</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export APP_NAME=$(yq r app-deploy.yaml metadata.name)
export IMAGE_NAME=${APP_NAME}
export IMAGE_TAG=${RANDOM}
appsody deploy \
  --tag "${NAMESPACE}/${IMAGE_NAME}:${IMAGE_TAG}" \
  --push-url "${IMAGE_REGISTRY}" \
  --pull-url "${INTERNAL_IMAGE_REGISTRY}"
  -n ${NAMESPACE} --knative</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_access_the_application"><a class="anchor" href="#_access_the_application"></a>Access the Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If not using knative</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export APP_URL=http://$(oc get route ${APP_NAME} -n ${NAMESPACE} -o jsonpath="{.spec.host}")</code></pre>
</div>
</div>
<div class="paragraph">
<p>If using knative</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export APP_URL=$(oc get ksvc ${APP_NAME} -n ${NAMESPACE} -o jsonpath="{.status.url}")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open with a browser or use curl</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">open ${APP_URL}
curl ${APP_URL}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_automate_appsody_deploy"><a class="anchor" href="#_automate_appsody_deploy"></a>Automate appsody deploy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create a <code>.env</code> file and a script <code>deploy.sh</code>. Use <code>./deploy.sh</code> everytime you want to deploy to the remote cluster</p>
</div>
<div class="paragraph">
<p>Run the following script in your terminal to create the two files <code>.env</code> and <code>deploy.sh</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">appsody deploy --generate-only -n $NAMESPACE

cat &lt;&lt;EOF &gt;.env
INTERNAL_IMAGE_REGISTRY=${INTERNAL_IMAGE_REGISTRY}
IMAGE_REGISTRY=${IMAGE_REGISTRY}
NAMESPACE=${NAMESPACE}
APP_NAME=$(yq r app-deploy.yaml metadata.name)
IMAGE_NAME=\${APP_NAME}
APP_KNATIVE=false
EOF

cat &lt;&lt;EOF &gt;deploy.sh
#!/bin/bash
source .env
IMAGE_TAG=\${RANDOM}

if ! oc get project \${NAMESPACE}; then
  echo project \${NAMESPACE} not found, creating new project \${NAMESPACE}
  oc new-project \${NAMESPACE}
fi

if [ "\$APP_KNATIVE" = "true" ]; then
  echo Deploying Serverless Service
  APP_KNATIVE_FLAG="--knative"
fi

appsody deploy \
  --tag \${NAMESPACE}/\${IMAGE_NAME}:\${IMAGE_TAG} \
  --push-url \${IMAGE_REGISTRY} \
  --pull-url \${INTERNAL_IMAGE_REGISTRY} \
  -n \${NAMESPACE} \${APP_KNATIVE_FLAG}

if [ "\$APP_KNATIVE" = "true" ]; then
  echo Getting Serveless Application URL...
  APP_URL=\$(oc get ksvc \${APP_NAME} -n \${NAMESPACE} -o jsonpath="{.status.url}")
else
  echo Getting Application URL...
  APP_URL=http://\$(oc get route \${APP_NAME} -n \${NAMESPACE} -o jsonpath="{.spec.host}")
fi

echo App deployed: \${APP_URL}
EOF
chmod +x deploy.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can automatically run <code>deploy.sh</code> on file change. You can use an utility like appsody watcher.</p>
</div>
<div class="paragraph">
<p>Install a tool to watch files and run a command when a file changes. For example <a href="https://github.com/emcrisostomo/fswatch" target="_blank" rel="noopener">fswatch</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># install appsody fswatch binary
brew install fswatch</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the following command excluding the directory <code>.git/</code> and the file <code>app-deploy.yaml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">fswatch -e .git/ -e app-deploy.yaml -o . | xargs -n1 -I{} "./deploy.sh"</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>You should use <code>appsody run</code> most of the time to work with your application locally, if there is a need to deploy to a remote cluster then use <code>./deploy.sh</code>.</p>
</li>
<li>
<p>The best practice is to push your code to a git repository, and letting the devops process take over to deploy to the cluster using one of these workflows:</p>
<div class="ulist">
<ul>
<li>
<p><a href="e2e-java-spring-boot2.html" class="page">E2E Java Spring Boot</a></p>
</li>
<li>
<p><a href="e2e-java-microprofile.html" class="page">E2E Java Liberty Microprofile</a></p>
</li>
<li>
<p><a href="e2e-nodejs-express.html" class="page">E2E Node.js Express</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
