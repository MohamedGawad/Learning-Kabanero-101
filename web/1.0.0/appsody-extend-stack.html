<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Appsody - Extending a Stack with Templates :: Learning-Kabanero-101</title>
    <link rel="canonical" href="https://github.com/ibm-cloud-architecture/Learning-Kabanero-101/web/1.0.0/appsody-extend-stack.html">
    <meta name="generator" content="Antora 2.0.1">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-149377589-1"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','UA-149377589-1')</script>
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <p>Learning Kabanero Enterprise 101</p>
      </div>
    </div>
    <div id="topbar-nav" class="navbar-menu">
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="web" data-version="1.0.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="kabanero-overview.html">Learning Kabanero Enterprise 101</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="kabanero-overview.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Installing Kabanero Enterprise</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-text"><a href="https://cloud.ibm.com/catalog/content/ibm-cp-applications" target="_blank" rel="noopener">Using IBM Cloud Console ↗</a></span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text"><a href="https://www.ibm.com/support/knowledgecenter/en/SSCSJL_4.x/install-icpa-cli.html" target="_blank" rel="noopener">OCP4 CLI Installer ↗</a></span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text"><a href="https://www.ibm.com/support/knowledgecenter/en/SSCSJL/install-icpa-cli.html" target="_blank" rel="noopener">OCP3 CLI Installer ↗</a></span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Workflows</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="e2e-java-spring-boot2.html">E2E Java Spring Boot 2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="e2e-java-microprofile.html">E2E Java Microprofile</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="e2e-nodejs-express.html">E2E Node.js Express</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Tasks</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="appsody-deploy.html">Appsody Deploy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="codewind-setup-appsody.html">Configure CodeWind</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="appsody-extend-stack.html">Extend Appsody Stack</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="tekton-create-pipeline.html">Extend Tekton Pipelines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="tekton-create-pipeline.html#nodejs-express-deploy">Deploy Test Pipelines</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="tekton-create-pipeline.html#nodejs-express">Test Node.js Express</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="tekton-create-pipeline.html#java-spring-boot2">Test Java Spring Boot Test</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="tekton-create-pipeline.html#java-microprofile">Test Java Microprofile</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tekton-credentials-github.html">Configure Github Credentials</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tekton-credentials-docker.html">Configure Docker Credentials</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">External Resources</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <span class="nav-text"><a href="https://developer.ibm.com/technologies/containers/tutorials/create-appsody-stack" target="_blank" rel="noopener">Create Appsody Stack ↗</a></span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text"><a href="https://github.com/gcharters/kabanero-dev-getting-started" target="_blank" rel="noopener">Java MicroProfile Tutorial ↗</a></span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text"><a href="https://developer.ibm.com/components/cloud-pak-for-applications" target="_blank" rel="noopener">IBM Cloud Pak for Applications @ IBM Developer ↗</a></span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="references.html">References</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Learning Kabanero Enterprise 101</span>
    <span class="version">1.0.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Learning Kabanero Enterprise 101</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="kabanero-overview.html">1.0.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main>
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="kabanero-overview.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="kabanero-overview.html">Learning Kabanero Enterprise 101</a></li>
    <li>Tasks</li>
    <li><a href="appsody-extend-stack.html">Extend Appsody Stack</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/ibm-cloud-architecture/Learning-Kabanero-101/edit/master/modules/ROOT/pages/appsody-extend-stack.adoc">Edit this Page</a></div>
  </div>
<article class="doc">
<h1 class="page">Appsody - Extending a Stack with Templates</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_prerequisites">Prerequisites</a></li>
<li><a href="#_getting_started">Getting Started</a></li>
<li><a href="#_creating_a_new_stack_template">Creating a New Stack Template</a></li>
<li><a href="#_building_the_stack">Building the Stack</a></li>
<li><a href="#_adding_the_repository_to_appsody">Adding the Repository to Appsody</a></li>
<li><a href="#_running_the_application">Running the Application</a></li>
<li><a href="#_adding_and_changing_packages">Adding and Changing Packages</a></li>
<li><a href="#_adding_environment_variables">Adding Environment Variables</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>The following command line (CLI) tools and configured:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://git-scm.com/book/en/v2/Getting-Started-Installing-Git">git</a></p>
</li>
<li>
<p><a href="https://appsody.dev/docs/getting-started/installation">appsody</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started"><a class="anchor" href="#_getting_started"></a>Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First we need to clone the stacks repository provided by appsody.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">git clone https://github.com/kabanero-io/collections.git
cd collections
git checkout v0.1.2</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Kabanero Collections repository provides us with all the stacks provided by Appsody as well as a sample stack in the <code>samples/sample-stack</code> directory.  The <code>sample stack</code> directory gives us the basic skeleton for starting a stack from scratch.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_a_new_stack_template"><a class="anchor" href="#_creating_a_new_stack_template"></a>Creating a New Stack Template</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For this walkthrough however we are going to create a new stack template based on an existing template.  In this case we are going to modify the <code>nodejs-express</code> stack&#8217;s <code>simple</code> template.  We are going to modify the <code>app.js</code> and the <code>README.md</code> files.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start by navigating to the <code>nodejs-express simple template</code> directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">pushd incubator/nodejs-express/templates</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can copy the simple template into a new directory, to create a new template.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cp -r simple/ simple-sample
cd simple-sample</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once in the simple-sample directory. Open the <code>simple-sample/app.js</code> file and add the following code to create a new endpoint for the application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-node hljs" data-lang="node">app.get('/test', (req, res) =&gt; {
  res.send("Testing a new Template in Appsody!!");
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Save the file and now we need to create a <code>simple-sample/README</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">touch simple-sample/README.md</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, add some content to <code>/simple-sample/README.md</code> file. Copy and paste the following into the <code>simple-sample/README.md</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-markdown hljs" data-lang="markdown"># Simple-Sample Template

This template uses Node.js with express.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Save the file and thats it for the changes for the template.</p>
</div>
<div class="paragraph">
<p>Return to the root of the project</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">popd</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_building_the_stack"><a class="anchor" href="#_building_the_stack"></a>Building the Stack</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now it&#8217;s time to add the new template into the stack. All we need to do is run the following command to start the package process.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">STACKS_LIST=incubator/nodejs-express ./ci/package.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see at the end of the build process success messages</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Successfully built ccc85e795e33
Successfully tagged appsody/appsody-index:latest
Successfully tagged appsody/appsody-index:SNAPSHOT
created appsody/appsody-index:SNAPSHOT</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_the_repository_to_appsody"><a class="anchor" href="#_adding_the_repository_to_appsody"></a>Adding the Repository to Appsody</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once the building of the new template is completed, we need to add the custom repository to appsody for it to run.</p>
</div>
<div class="paragraph">
<p>Add the repository to the list by runnning:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">appsody repo add custom-stack &lt;URL to the Stack incubator-index-local.yaml&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the full qualified directory path to the file <code>incubator-index-local.yaml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">appsody repo add custom-stack file://${PWD}/ci/assets/incubator-index-local.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify that the new template <code>simple</code> for the stack <code>nodejs-express</code> using the repository <code>custom-stack</code> is available:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">appsody list custom-stack

REPO            ID              VERSION         TEMPLATES                               DESCRIPTION
custom-stack    nodejs-express  0.2.6           *simple, simple-sample, skaffold        Express web framework for Node.js</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_the_application"><a class="anchor" href="#_running_the_application"></a>Running the Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To run the application we need to create a new directory and create a new appsody application inside it using the custom template.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mkdir custom-nodejs
cd custom-nodejs
appsody init custom-stack/nodejs-express simple-sample</code></pre>
</div>
</div>
<div class="paragraph">
<p>A new application is initialized into the new directory for you to be able to run.</p>
</div>
<div class="paragraph">
<p>Once the building is complete you can run the application with the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">appsody run</code></pre>
</div>
</div>
<div class="paragraph">
<p>A new instance of the application will start in a docker container and you can see your updated applcation code by navigating to <a href="http://localhost:3000/test" class="bare">http://localhost:3000/test</a> in your web browser</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="_images/extend_stack_appsody_running.png" alt="extend stack appsody running">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_and_changing_packages"><a class="anchor" href="#_adding_and_changing_packages"></a>Adding and Changing Packages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now let&#8217;s take a look at adding custom node packages for your stack or just changing the version of the packages in the template.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s first start by adding a distributed tracing package called Jaeger. Start in the home directory of the <code>incubator/nodejs-express</code> stack <code>${PWD}/collections/incubator/nodejs-express/</code>. Next, we want to modify the <code>package.json</code> to add the <code>jaeger-client</code> package to the stack.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd image/project
code package.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you open the <code>package.json</code> file you will se the <code>dependencies</code> section.  This is where we want to append <code>jaeger-client</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  "dependencies": {
    "@cloudnative/health-connect": "^2.0.0",
    "appmetrics-prometheus": "^3.0.0",
    "express": "~4.16.0",
    "jaeger-client": "3.17.0"
  },</pre>
</div>
</div>
<div class="paragraph">
<p>With <code>jaeger-client</code> appended, the <code>nodejs-express</code> stack will include <code>jaeger</code> version <code>3.17.0</code> with each build. In the <code>package.json</code> you have version control for all the packages within the <code>nodejs-express</code> stack that you would like.</p>
</div>
<div class="paragraph">
<p>To test and build the stack locally checkout: <a href="https://appsody.dev/docs/stacks/build-and-test#building-a-stack-image-locally-without-build-scripts">Appsody Build</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_environment_variables"><a class="anchor" href="#_adding_environment_variables"></a>Adding Environment Variables</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When using appsody stacks within large multi-application projects or multiple projects across an organization you may want to include environment variables with each project that uses a particular stack.  We can declare environment variables in the <code>Dockerfile</code> for stacks to use for each build.</p>
</div>
<div class="paragraph">
<p>You can read about the Appsody Environment Variables <a href="https://appsody.dev/docs/stacks/environment-variables">here</a>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s add one for our <code>jaeger-client</code> package to use.  In <code>jaeger</code> you can set a <code>Sampler-Type</code> with the categories <code>constant, probabilistic, rate limiting, remote</code>. Let&#8217;s add an environment variable to our stack where we declare the <code>Sampler-Type</code> to be <code>probabilistic</code> and set the percentage parameter for it to <code>0.5</code> for all new applications being built.</p>
</div>
<div class="paragraph">
<p>First navigate to and open the <code>Dockerfile</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd image/project
code Dockerfile</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the <code>Dockerfile</code> open all we need to do is add the following to line 31:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-docker hljs" data-lang="docker">ENV JAEGER_SAMPLER_TYPE probabilistic
ENV JAEGER_SAMPLER_PARM 0.5</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s it. Now every build of your stack will include the <code>Jaeger Sampler Type</code> as an environment variable.</p>
</div>
<div class="paragraph">
<p>Learn more about <a href="https://www.npmjs.com/package/jaeger-client">Jaeger</a></p>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
