= Nodejs-Express Using Kabanero
Carlos Santana <csantana@us.ibm.com>
v1.0, 2019-09-22
:toc:
:imagesdir: images

== Prerequisites

* https://cloud.ibm.com/kubernetes/catalog/openshiftcluster[Openshift Cluster]
** Kabenero Enterprise (Installed with IBM Cloud Pak for Applications)
*** Appsody Operator
*** Tekton Operator and TekTon Dashboard
*** Knative Operator
* Docker for Desktop - https://docs.docker.com/docker-for-mac/install/[Mac], https://docs.docker.com/docker-for-windows/install/[Windows]
* The following command line (CLI) tools and configured:
** docker - It comes with the Docker for Desktop installation.
** https://www.okd.io/download.html[oc]
** https://git-scm.com/book/en/v2/Getting-Started-Installing-Git[git]
** https://appsody.dev/docs/getting-started/installation[appsody]

== Add Kabanero Collection to appsody

- From the Cloud Pak for Applications landing page get the `Collection Hub` URL. For example in our example it is as follows.

`https://github.com/kabanero-io/collections/releases/download/v0.1.2/kabanero-index.yaml`

- Use the appsody CLI to add the Collection repo.

[source, bash]
----
appsody repo add kabanero https://github.com/kabanero-io/collections/releases/download/v0.1.2/kabanero-index.yaml
----

- If possible, remove other repos that are existing.

To get the list of available repos, run this command.

[source, bash]
----
appsody repo list
----

This returns you something like below.

[source, bash]
----
$ appsody repo list

NAME        	URL
*kabanero   	https://github.com/kabanero-io/collections/releases/download/v0.1.2/kabanero-index.yaml
appsodyhub  	https://github.com/appsody/stacks/releases/latest/download/incubator-index.yaml
experimental	https://github.com/appsody/stacks/releases/latest/download/experimental-index.yaml
----

To remove the unused repos, run

[source, bash]
----
appsody repo remove <NAME>
----

For instance, if you want to remove `appsodyhub`, then it will be `appsody repo remove appsodyhub`.

- List the appsody stacks available in the Collection:

[source, bash]
----
appsody list kabanero
----

It gives you the list of available stacks.

[source, bash]
----
$ appsody list kabanero

REPO    	ID               	VERSION  	TEMPLATES        	DESCRIPTION
kabanero	java-microprofile	0.2.11   	*default         	Eclipse MicroProfile on Open Liberty & OpenJ9 using Maven
kabanero	java-spring-boot2	0.3.9    	*default, kotlin 	Spring Boot using OpenJ9 and Maven
kabanero	nodejs           	0.2.5    	*simple          	Runtime for Node.js applications
kabanero	nodejs-express   	0.2.5    	*simple, skaffold	Express web framework for Node.js
kabanero	nodejs-loopback  	0.1.4    	*scaffold        	LoopBack 4 API Framework for Node.js
----

- Set the `kabanero` repo as default.

[source, bash]
----
appsody repo set-default kabanero
----

== Appsody application

=== Create a new Application

- Create a new directory for the project and change directory into it.

[source, bash]
----
mkdir appsody_sample_nodejs-express

cd appsody_sample_nodejs-express/
----

- Initialize the project using `appsody init` by selecting the desired stack ID template `simple`.

[source, bash]
----
appsody init kabanero/nodejs-express
----

=== Build the application

This command will locally build a docker image of your appsody project.

[source, bash]
----
appsody build
----

Once it builds successfully, you will see something like this.

[source, bash]
----
[Docker] Removing intermediate container 264b4dd86f2c
[Docker]  ---> 3a7e5ca613f2
[Docker] Step 20/21 : EXPOSE 3000
[Docker]  ---> Running in fb7b734205a8
[Docker] Removing intermediate container fb7b734205a8
[Docker]  ---> badce710593d
[Docker] Step 21/21 : CMD ["npm", "start"]
[Docker]  ---> Running in 961a344e2c68
[Docker] Removing intermediate container 961a344e2c68
[Docker]  ---> e417d7dfc54c
[Docker] Successfully built e417d7dfc54c
[Docker] Successfully tagged appsody-sample-nodejs-express:latest
Built docker image appsody-sample-nodejs-express
----

It helps you to check that stack is stable and init is done correctly. You do not need to run build directly ever again.

=== Test the Application

- Test the application using appsody

[source, bash]
----
appsody test
----

This step is building a container and running the test command inside of it.

[source, bash]
----
Running test environment
Running command: docker pull kabanero/nodejs-express:0.2
Running docker command: docker run --rm -p 3000:3000 -p 8080:8080 -p 9229:9229 --name appsody-sample-nodejs-express-dev -v /Users/csantanapr/dev/kabanero/appsody_sample_nodejs-express/:/project/user-app -v appsody-sample-nodejs-express-deps:/project/user-app/node_modules -v /Users/csantanapr/.appsody/appsody-controller:/appsody/appsody-controller -t --entrypoint /appsody/appsody-controller kabanero/nodejs-express:0.2 --mode=test
[Container] Running APPSODY_PREP command: npm install --prefix user-app
added 170 packages from 578 contributors and audited 295 packages in 2.76s
...
[Container] Running command:  npm test && npm test --prefix user-app
[Container]
[Container] > nodejs-express@0.2.6 test /project
[Container] > mocha
...
[Container] App started on PORT 3000
...
[Container]
[Container]   7 passing (44ms)
[Container]
[Container]
[Container] > nodejs-express-simple@0.1.0 test /project/user-app
[Container] > mocha
[Container]
...
[Container] App started on PORT 3000
[Container]   Node.js Express Simple template
[Container]     / endpoint
[Container]       âœ“ status
[Container]
[Container]
[Container]   1 passing (40ms)
[Container]
[Container] The file watcher is not running because no APPSODY_RUN/TEST/DEBUG_ON_CHANGE action was specified or it has been disabled using the --no-watcher flag.
----

=== Run the Application

- Run the application using appsody

[source, bash]
----
appsody run
----

This step is building a container and running it, the output has the endpoint for the application.

[source, bash]
----
Running development environment...
Running command: docker pull kabanero/nodejs-express:0.2
Running docker command: docker run --rm -p 3000:3000 -p 8080:8080 -p 9229:9229 --name appsody-sample-nodejs-express-dev -v /Users/csantanapr/dev/kabanero/appsody_sample_nodejs-express/:/project/user-app -v appsody-sample-nodejs-express-deps:/project/user-app/node_modules -v /Users/csantanapr/.appsody/appsody-controller:/appsody/appsody-controller -t --entrypoint /appsody/appsody-controller kabanero/nodejs-express:0.2 --mode=run
[Container] Running APPSODY_PREP command: npm install --prefix user-app
audited 295 packages in 1.546s
[Container] found 0 vulnerabilities
[Container]
[Container] Running command:  npm start
[Container]
[Container] > nodejs-express@0.2.6 start /project
[Container] > node server.js
[Container]
[Container] [Sun Sep 22 23:29:50 2019] com.ibm.diagnostics.healthcenter.loader INFO: Node Application Metrics 5.0.5.201909191743 (Agent Core 4.0.5)
[Container] [Sun Sep 22 23:29:51 2019] com.ibm.diagnostics.healthcenter.mqtt INFO: Connecting to broker localhost:1883
[Container] App started on PORT 3000
----

- Open the application using the web browser at http://localhost:3000 .

- By default, the template provides the below endpoints.

** Readiness endpoint: http://localhost:3000/ready
** Liveness endpoint: http://localhost:3000/live
** Health check endpoint: http://localhost:3000/health
** Metrics endpoint: http://localhost:3000/metrics

For more details, refer https://github.com/appsody/stacks/blob/master/incubator/nodejs-express/README.md[Node.js Express Stack].

=== Stop the Application

- To stop the application container, run this command.

[source, bash]
----
appsody stop
----

- Alternatively, you can also press `Ctrl+C`.

=== Debug the Application

- Open your editor. We are using `VS Code`. Add the project to your workspace, or use the command `code .` .

image::js_lab1_vscode_project.png[align="center"]

- Open a new terminal window inside VS Code use `View->Terminal`

image::js_lab1_vscode_terminal.png[align="center"]

 - To debug the application including reloading the application on code changes run the below command.

[source, bash]
----
appsody debug
----

The output indicates the debug environment is being used

[source, bash]
----
Running debug environment
Running command: docker pull kabanero/nodejs-express:0.2
Running docker command: docker run --rm -p 3000:3000 -p 8080:8080 -p 9229:9229 --name appsody-sample-nodejs-express-dev -v /Users/csantana23/dev/kabanero/appsody_sample_nodejs-express/:/project/user-app -v appsody-sample-nodejs-express-deps:/project/user-app/node_modules -v /Users/csantana23/.appsody/appsody-controller:/appsody/appsody-controller -t --entrypoint /appsody/appsody-controller kabanero/nodejs-express:0.2 --mode=debug
[Container] Running APPSODY_PREP command: npm install --prefix user-app
audited 295 packages in 1.154s
[Container] found 0 vulnerabilities
[Container]
[Container] Running command:  npm run debug
[Container]
[Container] > nodejs-express@0.2.6 debug /project
[Container] > node --inspect=0.0.0.0 server.js
[Container]
[Container] Debugger listening on ws://0.0.0.0:9229/35c7d2cb-ced9-4c57-94f1-a58a5e078302
[Container] For help, see: https://nodejs.org/en/docs/inspector
[Container] [Sun Sep 22 23:38:35 2019] com.ibm.diagnostics.healthcenter.loader INFO: Node Application Metrics 5.0.5.201909191743 (Agent Core 4.0.5)
[Container] [Sun Sep 22 23:38:35 2019] com.ibm.diagnostics.healthcenter.mqtt INFO: Connecting to broker localhost:1883
[Container] App started on PORT 3000
----


- Now you can open the application at http://localhost:3000/

image::js_lab1_endpoint.png[align="center"]

- Let us make a code change.

image::sb_lab1_code_change.png[align="center"]

Here, the debugger will reload the application for you.

- Refresh the browser to see the changes.

image::js_lab1_endpoint_test.png[align="center"]

- Stop the appication usig `Ctrl+C`

- You ca attach to the Node.js debugger using `VSCode`

- To access the debug view use `View->Debug` or click Debug icon on left menu

image::js_lab1_vscode_debug.png[align="center"]

- Add a break point to the application, click to the left of the line number

image::js_lab1_vscode_breakpoint.png[align="center"]

- Click on the debug task `Appsody: Attach node`

image::js_lab1_vscode_attach.png[align="center"]

- Refresh the browser and watch how the debugger stops at the break point

image::js_lab1_vscode_attach_break.png[align="center"]

== Deploy the appsody application on Openshift for personal development

*TBD*

== Appsody tasks on VS Code

- To access the build tasks on VS code, go to

----
Terminal > Run Build Task...
----

image::js_lab1_build_task_menu.png[align="center"]

- You will see a list of available tasks.

image::js_lab1_build_task_list.png[align="center"]

- Click on `Appsody: run` and this will run the application.

image::js_lab1_build_task_run.png[align="center"]

- Once, it is successfully started, you can access the application at http://localhost:3000/

image::js_lab1_endpoint.png[align="center"]

- Run the `Appsody: stop` task

image::js_lab1_build_task_stop.png[align="center"]
